\color{black}
\section{Introducción}

Para ilustrar la facilidad con que \textbf{FlavorPHP} nos permite crear aplicaciones web con pocas lineas de código, crearemos una aplicación que nos permita almacenar nuestros enlaces favoritos.

Lo primero que debemos hacer es descomprimir \textbf{FlavorPHP} en nuestro servidor y llamarle a nuestra aplicacion \texttt{demo} (el nombre de la carpeta que contiene al framework).

El siguiente paso es realizar la configuración en el archivo \texttt{config.php}.

Una vez que hayamos configurado correctamente, procedemos a crear la tabla en la base de datos.

\section{El modelo de datos}

Necesitaremos una tabla en nuestra base de datos (BD), la cual almacenará nuestros enlaces. Esta tabla la llamaremos \textbf{bookmarks}.

Los campos a utilizar se describen en la tabla~\ref{CuadroBookmarks}.

\begin{table}[!hp]
\caption{Campos en la tabla bookmarks}
\label{CuadroBookmarks}
\begin{center}
\begin{tabular}{l l} \hline
  \textbf{Campo} & \textbf{Utilidad} \\ \hline \\
  id\_link & \parbox{7cm}{Valor numérico que se llena automáticamente de forma incremental (debe ser llave primaria).}  \\ \\
  title & \parbox{7cm}{Almacena el título del sitio Web.}  \\ \\
  url & \parbox{7cm}{Almacena el enlace al sitio Web.}  \\ \\
  description & \parbox{7cm}{Descripción del sitio Web.}  \\ \\
  tags & \parbox{7cm}{Etiquetas para organizar los sitios Web.}  \\ \\  
  created & \parbox{7cm}{Este Campo lo llena automáticamente \textbf{FlavorPHP} al agregar un nuevo sitio Web.}  \\ \\
  modified.php & \parbox{7cm}{Este Campo lo llena automáticamente \textbf{FlavorPHP} cuando se modifica un enlace.}  \\ \\  
  \hline
\end{tabular}
\end{center}
\end{table}

Como podemos ver, existen tres campos por convención que necesita y usa \textbf{FlavorPHP}:

\begin{enumerate}
	\item Campo llave primaria (id\_link), en este campo no importa el nombre.
	\item Campo \textbf{created}.
	\item Campo \textbf{modified}.
\end{enumerate}

\subsection{Crear la BD}

El script para generar la base de datos lo encontramos en el código~\ref{lst:tablaBookmarks}.

\color{normal}
\begin{lstlisting}[frame=tb, caption=Tabla bookmarks, label=lst:tablaBookmarks, showspaces=false]{}
CREATE TABLE `bookmarks` (
  `id_link` int(3) NOT NULL auto_increment,
  `title` varchar(100) NOT NULL default '',
  `url` varchar(100) NOT NULL default '',
  `description` text ,
  `tags` varchar(75) NOT NULL default '',
  `created` datetime NOT NULL,
  `modified` datetime NOT NULL,
  PRIMARY KEY  (`id_link`)
);
\end{lstlisting}
\color{black}

\textsl{\textbf{Nota:} Para poder apreciar el ejemplo inserte en esta parte un par de registros a su tabla de forma manual.}

\subsection{Crear el modelo}

Los modelos forman parte del MVC, representan la lógica de datos y encapsulan las acciones que se podrán hacer sobre las tablas en las bases de datos, tales como insertar, modificar, borrar, consultar, etc. 

Los modelos en \textbf{FlavorPHP}, implementan el patrón ORM (Mapeo Objeto Relacional), el cual nos permite trabajar con nuestras tablas como si fueran clases y nuestros registros como si fueran objetos. Estos modelos mapean directamente nuestas tablas en las bases de datos, debido a esto, debemos tomar en cuenta \textbf{otra convención}, el modelo \textbf{se debe de llamar} como la tabla que vamos a mapear \textbf{pero en singular}. Es decir, si nuestra tabla se llama \texttt{bookmarks} nuestro modelo se llamará \texttt{bookmark}.

Este modelo (ver código~\ref{lst:modeloBookmarks}) lo vamos a crear en el directorio \texttt{models} de la siguiente forma:  \emph{/models/\textbf{bookmark.php}}.

\color{normal}
\begin{lstlisting}[frame=tb, caption=Modelo bookmarks, label=lst:modeloBookmarks, showspaces=false]{}
class bookmark extends models {
	
}
\end{lstlisting}
\color{black}

Con este modelo será suficiente para nuestra aplicación. \textbf{FlavorPHP} automáticamente ya ha creado un enlace entre nuestro modelo y la tabla en la BD por lo que ya podemos trabajar con ella como si de un objeto se tratara.

\section{Crear los controladores y las vistas}

Vamos a crear los controladores y vistas necesarias para nuestra aplicación.

\subsection{Usando un modelo desde un controlador}

Lo primero que debemos hacer es crear el controlador \texttt{index} (ver código~\ref{lst:indexController}), es decir \textit{/controllers/\textbf{index\_controller.php}}.

\color{normal}
\begin{lstlisting}[frame=tb, caption=Bookmarks - index\_controller.php, label=lst:indexController, showspaces=false]{}
class index_controller extends appcontroller {
		public function __construct() {
			parent::__construct();
				
		}	
	  public function index($id=NULL) {		
		
	  }	
}
\end{lstlisting}
\color{black}

Ya que tenemos nuestro controlador, le agregamos el código siguiente:

\color{normal}
\begin{lstlisting}[frame=tb, caption=Seleccionar todos, label=lst:indexController2, showspaces=false]{}
class index_controller extends appcontroller {
		public function __construct() {
			parent::__construct();
				
		}		
		public function index($id=null){
			$link = new bookmark();
			$this->view->links = $link->findAll();
			$this->render();
		}
}
\end{lstlisting}
\color{black}

En la línea 3 se llama al modelo que creamos previamente, después le asignamos a la vista una variable que contendrá todos los enlaces en nuestra tabla y por último mostramos la vista.

\subsection{Crear la vista}

Creamos nuestra vista (ver código~\ref{lst:indexVista}) en \textit{/views/index/\textbf{index.php}}

\color{normal}
\begin{lstlisting}[frame=tb, caption=La vista del index, label=lst:indexVista, showspaces=false]{}
<?php foreach ($links as $link) { ?>
	<a href="<?php echo $link["url"]; ?>"><?php echo $link["title"]; ?></a>
	<p><? echo $link["description"]; ?></p>
	<p><? echo $link["tags"]; ?> el 
	<? echo date("m.d.y", strtotime($link["created"])); ?></p>
<?php } ?>
\end{lstlisting}
\color{black}

Ahora que conocemos como conectarnos a la BD, obtener todos los registros y desplegarlos en nuestro navegador con muy pocas lineas de código, aprendamos a realizar las operaciones de insertar, modificar y eliminar enlaces en nuestra aplicación.

A nuestra vista le agregamos las siguientes líneas (ver código~\ref{lst:indexVista2}), para generar las URLs de editar, eliminar y agregar enlaces.

\color{normal}
\begin{lstlisting}[frame=tb, caption=La vista con operaciones de CRUD, label=lst:indexVista2, showspaces=false]{}
<p>
<?php echo $this->html->linkTo("Agregar enlace", "index/agregar/", " title=\"Agregar un nuevo enlace\""); ?>
</p>
<hr />
<?php foreach ($links as $link) { ?>
	<a href="<?php echo $link["url"]; ?>"><?php echo $link["title"]; ?></a>
    
	<p><?php echo $link["description"]; ?></p>
	<p><?php echo $link["tags"]; ?> el 
	<?php echo date("m.d.y", strtotime($link["created"])); ?></p>
    <p>Operaciones con el enlace: <?php echo $this->html->linkTo("Editar", "index/editar/".$link["id_link"]."/", " title=\"Editar enlace\""); ?>  | 
    <?php echo $this->html->linkToConfirm("Eliminar", "index/eliminar/".$link["id_link"]."/"); ?>
    </p>
<?php } ?>  \end{lstlisting}
\color{black}


Como podemos observar, en nuestra vista estamos usando un objeto \texttt{html}, este es el helper HTML que incluye FlavorPHP y nos permite crear elementos HTML de forma más sencilla y respetando siempre la estructura del framework, los dos métodos del helper que en estos momentos hemos utilizado son los siguientes:

\begin{enumerate}
	\item \texttt{linkTo(text, url, html\_attributes)} .- Crea un enlace. Los parametros son:
		\begin{description}
			\item[text] Texto que llevará el enlace.
			\item[url] URL a donde se dirijirá el usuario.
			\item[html\_attributes] Atributos extras del enlace.
		\end{description}	 
	\item \texttt{linkToConfirm(text, url)} .- Crea un enlace, el cual para activarse, el usuario primero debe aceptarlo. Los parametros son:	
		\begin{description}
			\item[text] Texto que llevará el enlace.
			\item[url] URL a donde se dirijirá el usuario.
		\end{description}
\end{enumerate}

\subsection{Agregar enlace}

En el código~\ref{lst:metodoAgregar} veremos como queda el método agregar.

\color{normal}
\begin{lstlisting}[frame=tb, caption=Agregar enlace, label=lst:metodoAgregar, showspaces=false]{}
public function agregar($id=null){
		$link = new bookmark();
		if($this->data){
			$link->prepareFromArray($this->data);
			$link->save();
			$this->redirect("index");
		} else {
			$this->title_for_layout("Agregar Enlace");
			$this->render();
		}
}\end{lstlisting}
\color{black}

Y la vista para agregar \emph{/views/index/\textbf{agregar.php}} (ver código~\ref{lst:vistaAgregar})

\color{normal}
\begin{lstlisting}[frame=tb, caption=Agregar enlace, label=lst:metodoAgregar, showspaces=false]{}
<?php echo $this->html->form("index/agregar/"); ?>
	URL: <?php echo $this->html->textField("url"); ?>
	<br />
	Titulo: <?php echo $this->html->textField("title"); ?>
	<br />
	Descripcion: <?php echo $this->html->textArea("description", "", " rows=\"3\" cols=\"84\" "); ?>
	<br />
	Etiquetas: <?php echo $this->html->textField("tags"); ?>
	<br />
	<input type="submit" value="Agregar" /><br />
</form>
\end{lstlisting}
\color{black}

\subsection{Editar enlace}

En el código~\ref{lst:metodoEditar} veremos como queda el método editar.

\color{normal}
\begin{lstlisting}[frame=tb, caption=Editar enlace, label=lst:metodoEditar, showspaces=false]{}
public function editar($id){
		$link = new bookmark();
		$this->view->link = $link->find($id);
		$this->view->id = $id;
		if($this->data){
			$link->prepareFromArray($this->data);
			$link->save();
			$this->redirect("index");
		} else {
			$this->title_for_layout("Editar Enlace");
			$this->render();
		}
}\end{lstlisting}
\color{black}

Y la vista para editar \emph{/views/index/\textbf{editar.php}} (ver código~\ref{lst:vistaEditar})

\color{normal}
\begin{lstlisting}[frame=tb, caption=Vista editar enlace, label=lst:vistaEditar, showspaces=false]{}
<?php echo $this->html->form("index/editar/".$id."/"); ?>
	URL: <?php echo $this->html->textField("url", " value=\"".$link["url"]."\" "); ?>
	<br />
	Titulo: <?php echo $this->html->textField("title", " value=\"".$link["title"]."\" "); ?>
	<br />
	Descripcion: <?php echo $this->html->textArea("description", $link["description"], " rows=\"3\" cols=\"84\" "); ?>
	<br />
	Etiquetas: <?php echo $this->html->textField("tags", " value=\"".$link["tags"]."\" "); ?>
	<br />
	<input type="submit" value="Modificar" /><br />
</form>
\end{lstlisting}
\color{black}

\subsection{Eliminar enlace}

En el código~\ref{lst:metodoEliminar} veremos como queda el método eliminar.

\color{normal}
\begin{lstlisting}[frame=tb, caption=Eliminar enlace, label=lst:metodoEliminar, showspaces=false]{}
public function eliminar($id){
		$link = new bookmark();
		$link->find($id);
		$link->delete();
		$this->redirect("index");
}\end{lstlisting}
\color{black}


Recordemos que todos estos métodos anteriores deben de ir en el index\_controller que creamos al inicio \emph{/controllers/\textbf{index\_controller.php}}

Este ejemplo nos permite entrar de lleno al uso de \textbf{FlavorPHP}, por lo que el siguiente paso es conocer el API completa del framework para obtener el máximo provecho de su funcionalidad.